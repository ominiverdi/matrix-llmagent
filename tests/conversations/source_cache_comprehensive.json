{
  "_comment": "Comprehensive test for source caching across web, KB, and library - tests explicit, ambiguous, and news queries",
  "description": "Test source caching with human-like queries (explicit and ambiguous)",
  "timeout_seconds": 300,
  "mode": "agent",
  "steps": [
    {
      "_comment": "=== INITIAL STATE ===",
      "input": "!sources",
      "expect_contains": ["No sources"],
      "expect_not_contains": []
    },

    {
      "_comment": "=== AMBIGUOUS QUERY 1: general question, model chooses tool ===",
      "input": "tell me about QGIS",
      "expect_not_contains": ["failed", "error"],
      "expect_contains": []
    },
    {
      "_comment": "Check what source was used (could be KB, web, or none)",
      "input": "!sources",
      "expect_contains": [],
      "expect_not_contains": []
    },

    {
      "_comment": "=== EXPLICIT KB QUERY (mentions wiki) ===",
      "input": "what does the OSGeo wiki say about GeoServer?",
      "expect_not_contains": ["failed", "Search failed"],
      "expect_contains": []
    },
    {
      "_comment": "Verify KB sources are cached",
      "input": "!sources",
      "expect_contains": ["Sources from last search"],
      "expect_not_contains": ["No sources"]
    },
    {
      "_comment": "Test source detail",
      "input": "!source 1",
      "expect_contains": ["GeoServer"],
      "expect_not_contains": ["Invalid"]
    },

    {
      "_comment": "=== AMBIGUOUS NEWS QUERY: could be KB (OSGeo News) or web - model decides ===",
      "input": "what's the latest news about PostGIS?",
      "expect_not_contains": ["failed"],
      "expect_contains": []
    },
    {
      "_comment": "Sources exist - could be KB (OSGeo News) or web search",
      "input": "!sources",
      "expect_contains": [],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== EXPLICIT WEB SEARCH (says 'search the web') ===",
      "input": "search the web for GDAL 3.9 release notes",
      "expect_not_contains": ["failed", "Search failed"],
      "expect_contains": []
    },
    {
      "_comment": "Verify web search sources are cached",
      "input": "!sources",
      "expect_contains": ["Sources from last web search"],
      "expect_not_contains": ["No sources"]
    },
    {
      "_comment": "Test web source detail",
      "input": "!source 1",
      "expect_contains": [],
      "expect_not_contains": ["Invalid"]
    },

    {
      "_comment": "=== SIMPLE QUESTION (no tool needed) ===",
      "input": "what is 5 times 7?",
      "expect_contains": ["35"],
      "expect_not_contains": ["failed"]
    },
    {
      "_comment": "Sources should still show previous web search (most recent search)",
      "input": "!sources",
      "expect_contains": ["Sources from last web search", "GDAL"],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== EXPLICIT LIBRARY SEARCH ===",
      "input": "search the library for remote sensing",
      "expect_not_contains": ["failed", "not configured"],
      "expect_contains": []
    },
    {
      "_comment": "Verify library sources are cached",
      "input": "!sources",
      "expect_contains": ["Sources"],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== AMBIGUOUS QUERY: 'president' - KB has relationship data ===",
      "input": "who is the president of OSGeo?",
      "expect_not_contains": ["failed"],
      "expect_contains": []
    },
    {
      "_comment": "Check sources - likely KB (relationship_search) but could be web",
      "input": "!sources",
      "expect_contains": [],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== EXPLICIT KB QUERY (mentions wiki) ===",
      "input": "according to the wiki, what is MapServer?",
      "expect_not_contains": ["failed", "Search failed"],
      "expect_contains": []
    },
    {
      "_comment": "Sources may show KB or previous (model may answer from knowledge)",
      "input": "!sources",
      "expect_contains": ["Sources"],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== EXPLICIT WEB SEARCH (says 'search the internet') ===",
      "input": "search the internet for FOSS4G 2025 location",
      "expect_not_contains": ["failed", "Search failed"],
      "expect_contains": []
    },
    {
      "_comment": "Sources exist (web if tool used, or previous - model may answer from knowledge)",
      "input": "!sources",
      "expect_contains": ["Sources"],
      "expect_not_contains": ["No sources"]
    },

    {
      "_comment": "=== AMBIGUOUS NEWS QUERY 2: OSGeo news could be in KB ===",
      "input": "any recent OSGeo announcements?",
      "expect_not_contains": ["failed"],
      "expect_contains": []
    },
    {
      "_comment": "Sources exist - could be KB (OSGeo News/wiki) or web",
      "input": "!sources",
      "expect_contains": ["Sources"],
      "expect_not_contains": ["No sources"]
    }
  ]
}
